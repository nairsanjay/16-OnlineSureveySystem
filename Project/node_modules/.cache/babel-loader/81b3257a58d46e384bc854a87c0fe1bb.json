{"ast":null,"code":"var Reporter = require('../base').Reporter;\n\nvar EncoderBuffer = require('../base').EncoderBuffer;\n\nvar DecoderBuffer = require('../base').DecoderBuffer;\n\nvar assert = require('minimalistic-assert'); // Supported tags\n\n\nvar tags = ['seq', 'seqof', 'set', 'setof', 'objid', 'bool', 'gentime', 'utctime', 'null_', 'enum', 'int', 'objDesc', 'bitstr', 'bmpstr', 'charstr', 'genstr', 'graphstr', 'ia5str', 'iso646str', 'numstr', 'octstr', 'printstr', 't61str', 'unistr', 'utf8str', 'videostr']; // Public methods list\n\nvar methods = ['key', 'obj', 'use', 'optional', 'explicit', 'implicit', 'def', 'choice', 'any', 'contains'].concat(tags); // Overrided methods list\n\nvar overrided = ['_peekTag', '_decodeTag', '_use', '_decodeStr', '_decodeObjid', '_decodeTime', '_decodeNull', '_decodeInt', '_decodeBool', '_decodeList', '_encodeComposite', '_encodeStr', '_encodeObjid', '_encodeTime', '_encodeNull', '_encodeInt', '_encodeBool'];\n\nfunction Node(enc, parent) {\n  var state = {};\n  this._baseState = state;\n  state.enc = enc;\n  state.parent = parent || null;\n  state.children = null; // State\n\n  state.tag = null;\n  state.args = null;\n  state.reverseArgs = null;\n  state.choice = null;\n  state.optional = false;\n  state.any = false;\n  state.obj = false;\n  state.use = null;\n  state.useDecoder = null;\n  state.key = null;\n  state['default'] = null;\n  state.explicit = null;\n  state.implicit = null;\n  state.contains = null; // Should create new instance on each method\n\n  if (!state.parent) {\n    state.children = [];\n\n    this._wrap();\n  }\n}\n\nmodule.exports = Node;\nvar stateProps = ['enc', 'parent', 'children', 'tag', 'args', 'reverseArgs', 'choice', 'optional', 'any', 'obj', 'use', 'alteredUse', 'key', 'default', 'explicit', 'implicit', 'contains'];\n\nNode.prototype.clone = function clone() {\n  var state = this._baseState;\n  var cstate = {};\n  stateProps.forEach(function (prop) {\n    cstate[prop] = state[prop];\n  });\n  var res = new this.constructor(cstate.parent);\n  res._baseState = cstate;\n  return res;\n};\n\nNode.prototype._wrap = function wrap() {\n  var state = this._baseState;\n  methods.forEach(function (method) {\n    this[method] = function _wrappedMethod() {\n      var clone = new this.constructor(this);\n      state.children.push(clone);\n      return clone[method].apply(clone, arguments);\n    };\n  }, this);\n};\n\nNode.prototype._init = function init(body) {\n  var state = this._baseState;\n  assert(state.parent === null);\n  body.call(this); // Filter children\n\n  state.children = state.children.filter(function (child) {\n    return child._baseState.parent === this;\n  }, this);\n  assert.equal(state.children.length, 1, 'Root node can have only one child');\n};\n\nNode.prototype._useArgs = function useArgs(args) {\n  var state = this._baseState; // Filter children and args\n\n  var children = args.filter(function (arg) {\n    return arg instanceof this.constructor;\n  }, this);\n  args = args.filter(function (arg) {\n    return !(arg instanceof this.constructor);\n  }, this);\n\n  if (children.length !== 0) {\n    assert(state.children === null);\n    state.children = children; // Replace parent to maintain backward link\n\n    children.forEach(function (child) {\n      child._baseState.parent = this;\n    }, this);\n  }\n\n  if (args.length !== 0) {\n    assert(state.args === null);\n    state.args = args;\n    state.reverseArgs = args.map(function (arg) {\n      if (typeof arg !== 'object' || arg.constructor !== Object) return arg;\n      var res = {};\n      Object.keys(arg).forEach(function (key) {\n        if (key == (key | 0)) key |= 0;\n        var value = arg[key];\n        res[value] = key;\n      });\n      return res;\n    });\n  }\n}; //\n// Overrided methods\n//\n\n\noverrided.forEach(function (method) {\n  Node.prototype[method] = function _overrided() {\n    var state = this._baseState;\n    throw new Error(method + ' not implemented for encoding: ' + state.enc);\n  };\n}); //\n// Public methods\n//\n\ntags.forEach(function (tag) {\n  Node.prototype[tag] = function _tagMethod() {\n    var state = this._baseState;\n    var args = Array.prototype.slice.call(arguments);\n    assert(state.tag === null);\n    state.tag = tag;\n\n    this._useArgs(args);\n\n    return this;\n  };\n});\n\nNode.prototype.use = function use(item) {\n  assert(item);\n  var state = this._baseState;\n  assert(state.use === null);\n  state.use = item;\n  return this;\n};\n\nNode.prototype.optional = function optional() {\n  var state = this._baseState;\n  state.optional = true;\n  return this;\n};\n\nNode.prototype.def = function def(val) {\n  var state = this._baseState;\n  assert(state['default'] === null);\n  state['default'] = val;\n  state.optional = true;\n  return this;\n};\n\nNode.prototype.explicit = function explicit(num) {\n  var state = this._baseState;\n  assert(state.explicit === null && state.implicit === null);\n  state.explicit = num;\n  return this;\n};\n\nNode.prototype.implicit = function implicit(num) {\n  var state = this._baseState;\n  assert(state.explicit === null && state.implicit === null);\n  state.implicit = num;\n  return this;\n};\n\nNode.prototype.obj = function obj() {\n  var state = this._baseState;\n  var args = Array.prototype.slice.call(arguments);\n  state.obj = true;\n  if (args.length !== 0) this._useArgs(args);\n  return this;\n};\n\nNode.prototype.key = function key(newKey) {\n  var state = this._baseState;\n  assert(state.key === null);\n  state.key = newKey;\n  return this;\n};\n\nNode.prototype.any = function any() {\n  var state = this._baseState;\n  state.any = true;\n  return this;\n};\n\nNode.prototype.choice = function choice(obj) {\n  var state = this._baseState;\n  assert(state.choice === null);\n  state.choice = obj;\n\n  this._useArgs(Object.keys(obj).map(function (key) {\n    return obj[key];\n  }));\n\n  return this;\n};\n\nNode.prototype.contains = function contains(item) {\n  var state = this._baseState;\n  assert(state.use === null);\n  state.contains = item;\n  return this;\n}; //\n// Decoding\n//\n\n\nNode.prototype._decode = function decode(input, options) {\n  var state = this._baseState; // Decode root node\n\n  if (state.parent === null) return input.wrapResult(state.children[0]._decode(input, options));\n  var result = state['default'];\n  var present = true;\n  var prevKey = null;\n  if (state.key !== null) prevKey = input.enterKey(state.key); // Check if tag is there\n\n  if (state.optional) {\n    var tag = null;\n    if (state.explicit !== null) tag = state.explicit;else if (state.implicit !== null) tag = state.implicit;else if (state.tag !== null) tag = state.tag;\n\n    if (tag === null && !state.any) {\n      // Trial and Error\n      var save = input.save();\n\n      try {\n        if (state.choice === null) this._decodeGeneric(state.tag, input, options);else this._decodeChoice(input, options);\n        present = true;\n      } catch (e) {\n        present = false;\n      }\n\n      input.restore(save);\n    } else {\n      present = this._peekTag(input, tag, state.any);\n      if (input.isError(present)) return present;\n    }\n  } // Push object on stack\n\n\n  var prevObj;\n  if (state.obj && present) prevObj = input.enterObject();\n\n  if (present) {\n    // Unwrap explicit values\n    if (state.explicit !== null) {\n      var explicit = this._decodeTag(input, state.explicit);\n\n      if (input.isError(explicit)) return explicit;\n      input = explicit;\n    }\n\n    var start = input.offset; // Unwrap implicit and normal values\n\n    if (state.use === null && state.choice === null) {\n      if (state.any) var save = input.save();\n\n      var body = this._decodeTag(input, state.implicit !== null ? state.implicit : state.tag, state.any);\n\n      if (input.isError(body)) return body;\n      if (state.any) result = input.raw(save);else input = body;\n    }\n\n    if (options && options.track && state.tag !== null) options.track(input.path(), start, input.length, 'tagged');\n    if (options && options.track && state.tag !== null) options.track(input.path(), input.offset, input.length, 'content'); // Select proper method for tag\n\n    if (state.any) result = result;else if (state.choice === null) result = this._decodeGeneric(state.tag, input, options);else result = this._decodeChoice(input, options);\n    if (input.isError(result)) return result; // Decode children\n\n    if (!state.any && state.choice === null && state.children !== null) {\n      state.children.forEach(function decodeChildren(child) {\n        // NOTE: We are ignoring errors here, to let parser continue with other\n        // parts of encoded data\n        child._decode(input, options);\n      });\n    } // Decode contained/encoded by schema, only in bit or octet strings\n\n\n    if (state.contains && (state.tag === 'octstr' || state.tag === 'bitstr')) {\n      var data = new DecoderBuffer(result);\n      result = this._getUse(state.contains, input._reporterState.obj)._decode(data, options);\n    }\n  } // Pop object\n\n\n  if (state.obj && present) result = input.leaveObject(prevObj); // Set key\n\n  if (state.key !== null && (result !== null || present === true)) input.leaveKey(prevKey, state.key, result);else if (prevKey !== null) input.exitKey(prevKey);\n  return result;\n};\n\nNode.prototype._decodeGeneric = function decodeGeneric(tag, input, options) {\n  var state = this._baseState;\n  if (tag === 'seq' || tag === 'set') return null;\n  if (tag === 'seqof' || tag === 'setof') return this._decodeList(input, tag, state.args[0], options);else if (/str$/.test(tag)) return this._decodeStr(input, tag, options);else if (tag === 'objid' && state.args) return this._decodeObjid(input, state.args[0], state.args[1], options);else if (tag === 'objid') return this._decodeObjid(input, null, null, options);else if (tag === 'gentime' || tag === 'utctime') return this._decodeTime(input, tag, options);else if (tag === 'null_') return this._decodeNull(input, options);else if (tag === 'bool') return this._decodeBool(input, options);else if (tag === 'objDesc') return this._decodeStr(input, tag, options);else if (tag === 'int' || tag === 'enum') return this._decodeInt(input, state.args && state.args[0], options);\n\n  if (state.use !== null) {\n    return this._getUse(state.use, input._reporterState.obj)._decode(input, options);\n  } else {\n    return input.error('unknown tag: ' + tag);\n  }\n};\n\nNode.prototype._getUse = function _getUse(entity, obj) {\n  var state = this._baseState; // Create altered use decoder if implicit is set\n\n  state.useDecoder = this._use(entity, obj);\n  assert(state.useDecoder._baseState.parent === null);\n  state.useDecoder = state.useDecoder._baseState.children[0];\n\n  if (state.implicit !== state.useDecoder._baseState.implicit) {\n    state.useDecoder = state.useDecoder.clone();\n    state.useDecoder._baseState.implicit = state.implicit;\n  }\n\n  return state.useDecoder;\n};\n\nNode.prototype._decodeChoice = function decodeChoice(input, options) {\n  var state = this._baseState;\n  var result = null;\n  var match = false;\n  Object.keys(state.choice).some(function (key) {\n    var save = input.save();\n    var node = state.choice[key];\n\n    try {\n      var value = node._decode(input, options);\n\n      if (input.isError(value)) return false;\n      result = {\n        type: key,\n        value: value\n      };\n      match = true;\n    } catch (e) {\n      input.restore(save);\n      return false;\n    }\n\n    return true;\n  }, this);\n  if (!match) return input.error('Choice not matched');\n  return result;\n}; //\n// Encoding\n//\n\n\nNode.prototype._createEncoderBuffer = function createEncoderBuffer(data) {\n  return new EncoderBuffer(data, this.reporter);\n};\n\nNode.prototype._encode = function encode(data, reporter, parent) {\n  var state = this._baseState;\n  if (state['default'] !== null && state['default'] === data) return;\n\n  var result = this._encodeValue(data, reporter, parent);\n\n  if (result === undefined) return;\n  if (this._skipDefault(result, reporter, parent)) return;\n  return result;\n};\n\nNode.prototype._encodeValue = function encode(data, reporter, parent) {\n  var state = this._baseState; // Decode root node\n\n  if (state.parent === null) return state.children[0]._encode(data, reporter || new Reporter());\n  var result = null; // Set reporter to share it with a child class\n\n  this.reporter = reporter; // Check if data is there\n\n  if (state.optional && data === undefined) {\n    if (state['default'] !== null) data = state['default'];else return;\n  } // Encode children first\n\n\n  var content = null;\n  var primitive = false;\n\n  if (state.any) {\n    // Anything that was given is translated to buffer\n    result = this._createEncoderBuffer(data);\n  } else if (state.choice) {\n    result = this._encodeChoice(data, reporter);\n  } else if (state.contains) {\n    content = this._getUse(state.contains, parent)._encode(data, reporter);\n    primitive = true;\n  } else if (state.children) {\n    content = state.children.map(function (child) {\n      if (child._baseState.tag === 'null_') return child._encode(null, reporter, data);\n      if (child._baseState.key === null) return reporter.error('Child should have a key');\n      var prevKey = reporter.enterKey(child._baseState.key);\n      if (typeof data !== 'object') return reporter.error('Child expected, but input is not object');\n\n      var res = child._encode(data[child._baseState.key], reporter, data);\n\n      reporter.leaveKey(prevKey);\n      return res;\n    }, this).filter(function (child) {\n      return child;\n    });\n    content = this._createEncoderBuffer(content);\n  } else {\n    if (state.tag === 'seqof' || state.tag === 'setof') {\n      // TODO(indutny): this should be thrown on DSL level\n      if (!(state.args && state.args.length === 1)) return reporter.error('Too many args for : ' + state.tag);\n      if (!Array.isArray(data)) return reporter.error('seqof/setof, but data is not Array');\n      var child = this.clone();\n      child._baseState.implicit = null;\n      content = this._createEncoderBuffer(data.map(function (item) {\n        var state = this._baseState;\n        return this._getUse(state.args[0], data)._encode(item, reporter);\n      }, child));\n    } else if (state.use !== null) {\n      result = this._getUse(state.use, parent)._encode(data, reporter);\n    } else {\n      content = this._encodePrimitive(state.tag, data);\n      primitive = true;\n    }\n  } // Encode data itself\n\n\n  var result;\n\n  if (!state.any && state.choice === null) {\n    var tag = state.implicit !== null ? state.implicit : state.tag;\n    var cls = state.implicit === null ? 'universal' : 'context';\n\n    if (tag === null) {\n      if (state.use === null) reporter.error('Tag could be omitted only for .use()');\n    } else {\n      if (state.use === null) result = this._encodeComposite(tag, primitive, cls, content);\n    }\n  } // Wrap in explicit\n\n\n  if (state.explicit !== null) result = this._encodeComposite(state.explicit, false, 'context', result);\n  return result;\n};\n\nNode.prototype._encodeChoice = function encodeChoice(data, reporter) {\n  var state = this._baseState;\n  var node = state.choice[data.type];\n\n  if (!node) {\n    assert(false, data.type + ' not found in ' + JSON.stringify(Object.keys(state.choice)));\n  }\n\n  return node._encode(data.value, reporter);\n};\n\nNode.prototype._encodePrimitive = function encodePrimitive(tag, data) {\n  var state = this._baseState;\n  if (/str$/.test(tag)) return this._encodeStr(data, tag);else if (tag === 'objid' && state.args) return this._encodeObjid(data, state.reverseArgs[0], state.args[1]);else if (tag === 'objid') return this._encodeObjid(data, null, null);else if (tag === 'gentime' || tag === 'utctime') return this._encodeTime(data, tag);else if (tag === 'null_') return this._encodeNull();else if (tag === 'int' || tag === 'enum') return this._encodeInt(data, state.args && state.reverseArgs[0]);else if (tag === 'bool') return this._encodeBool(data);else if (tag === 'objDesc') return this._encodeStr(data, tag);else throw new Error('Unsupported tag: ' + tag);\n};\n\nNode.prototype._isNumstr = function isNumstr(str) {\n  return /^[0-9 ]*$/.test(str);\n};\n\nNode.prototype._isPrintstr = function isPrintstr(str) {\n  return /^[A-Za-z0-9 '\\(\\)\\+,\\-\\.\\/:=\\?]*$/.test(str);\n};","map":{"version":3,"sources":["C:/Users/abc/Documents/GitHub/16-OnlineSureveySystem/Project/node_modules/asn1.js/lib/asn1/base/node.js"],"names":["Reporter","require","EncoderBuffer","DecoderBuffer","assert","tags","methods","concat","overrided","Node","enc","parent","state","_baseState","children","tag","args","reverseArgs","choice","optional","any","obj","use","useDecoder","key","explicit","implicit","contains","_wrap","module","exports","stateProps","prototype","clone","cstate","forEach","prop","res","constructor","wrap","method","_wrappedMethod","push","apply","arguments","_init","init","body","call","filter","child","equal","length","_useArgs","useArgs","arg","map","Object","keys","value","_overrided","Error","_tagMethod","Array","slice","item","def","val","num","newKey","_decode","decode","input","options","wrapResult","result","present","prevKey","enterKey","save","_decodeGeneric","_decodeChoice","e","restore","_peekTag","isError","prevObj","enterObject","_decodeTag","start","offset","raw","track","path","decodeChildren","data","_getUse","_reporterState","leaveObject","leaveKey","exitKey","decodeGeneric","_decodeList","test","_decodeStr","_decodeObjid","_decodeTime","_decodeNull","_decodeBool","_decodeInt","error","entity","_use","decodeChoice","match","some","node","type","_createEncoderBuffer","createEncoderBuffer","reporter","_encode","encode","_encodeValue","undefined","_skipDefault","content","primitive","_encodeChoice","isArray","_encodePrimitive","cls","_encodeComposite","encodeChoice","JSON","stringify","encodePrimitive","_encodeStr","_encodeObjid","_encodeTime","_encodeNull","_encodeInt","_encodeBool","_isNumstr","isNumstr","str","_isPrintstr","isPrintstr"],"mappings":"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","sourcesContent":["var Reporter = require('../base').Reporter;\r\nvar EncoderBuffer = require('../base').EncoderBuffer;\r\nvar DecoderBuffer = require('../base').DecoderBuffer;\r\nvar assert = require('minimalistic-assert');\r\n\r\n// Supported tags\r\nvar tags = [\r\n  'seq', 'seqof', 'set', 'setof', 'objid', 'bool',\r\n  'gentime', 'utctime', 'null_', 'enum', 'int', 'objDesc',\r\n  'bitstr', 'bmpstr', 'charstr', 'genstr', 'graphstr', 'ia5str', 'iso646str',\r\n  'numstr', 'octstr', 'printstr', 't61str', 'unistr', 'utf8str', 'videostr'\r\n];\r\n\r\n// Public methods list\r\nvar methods = [\r\n  'key', 'obj', 'use', 'optional', 'explicit', 'implicit', 'def', 'choice',\r\n  'any', 'contains'\r\n].concat(tags);\r\n\r\n// Overrided methods list\r\nvar overrided = [\r\n  '_peekTag', '_decodeTag', '_use',\r\n  '_decodeStr', '_decodeObjid', '_decodeTime',\r\n  '_decodeNull', '_decodeInt', '_decodeBool', '_decodeList',\r\n\r\n  '_encodeComposite', '_encodeStr', '_encodeObjid', '_encodeTime',\r\n  '_encodeNull', '_encodeInt', '_encodeBool'\r\n];\r\n\r\nfunction Node(enc, parent) {\r\n  var state = {};\r\n  this._baseState = state;\r\n\r\n  state.enc = enc;\r\n\r\n  state.parent = parent || null;\r\n  state.children = null;\r\n\r\n  // State\r\n  state.tag = null;\r\n  state.args = null;\r\n  state.reverseArgs = null;\r\n  state.choice = null;\r\n  state.optional = false;\r\n  state.any = false;\r\n  state.obj = false;\r\n  state.use = null;\r\n  state.useDecoder = null;\r\n  state.key = null;\r\n  state['default'] = null;\r\n  state.explicit = null;\r\n  state.implicit = null;\r\n  state.contains = null;\r\n\r\n  // Should create new instance on each method\r\n  if (!state.parent) {\r\n    state.children = [];\r\n    this._wrap();\r\n  }\r\n}\r\nmodule.exports = Node;\r\n\r\nvar stateProps = [\r\n  'enc', 'parent', 'children', 'tag', 'args', 'reverseArgs', 'choice',\r\n  'optional', 'any', 'obj', 'use', 'alteredUse', 'key', 'default', 'explicit',\r\n  'implicit', 'contains'\r\n];\r\n\r\nNode.prototype.clone = function clone() {\r\n  var state = this._baseState;\r\n  var cstate = {};\r\n  stateProps.forEach(function(prop) {\r\n    cstate[prop] = state[prop];\r\n  });\r\n  var res = new this.constructor(cstate.parent);\r\n  res._baseState = cstate;\r\n  return res;\r\n};\r\n\r\nNode.prototype._wrap = function wrap() {\r\n  var state = this._baseState;\r\n  methods.forEach(function(method) {\r\n    this[method] = function _wrappedMethod() {\r\n      var clone = new this.constructor(this);\r\n      state.children.push(clone);\r\n      return clone[method].apply(clone, arguments);\r\n    };\r\n  }, this);\r\n};\r\n\r\nNode.prototype._init = function init(body) {\r\n  var state = this._baseState;\r\n\r\n  assert(state.parent === null);\r\n  body.call(this);\r\n\r\n  // Filter children\r\n  state.children = state.children.filter(function(child) {\r\n    return child._baseState.parent === this;\r\n  }, this);\r\n  assert.equal(state.children.length, 1, 'Root node can have only one child');\r\n};\r\n\r\nNode.prototype._useArgs = function useArgs(args) {\r\n  var state = this._baseState;\r\n\r\n  // Filter children and args\r\n  var children = args.filter(function(arg) {\r\n    return arg instanceof this.constructor;\r\n  }, this);\r\n  args = args.filter(function(arg) {\r\n    return !(arg instanceof this.constructor);\r\n  }, this);\r\n\r\n  if (children.length !== 0) {\r\n    assert(state.children === null);\r\n    state.children = children;\r\n\r\n    // Replace parent to maintain backward link\r\n    children.forEach(function(child) {\r\n      child._baseState.parent = this;\r\n    }, this);\r\n  }\r\n  if (args.length !== 0) {\r\n    assert(state.args === null);\r\n    state.args = args;\r\n    state.reverseArgs = args.map(function(arg) {\r\n      if (typeof arg !== 'object' || arg.constructor !== Object)\r\n        return arg;\r\n\r\n      var res = {};\r\n      Object.keys(arg).forEach(function(key) {\r\n        if (key == (key | 0))\r\n          key |= 0;\r\n        var value = arg[key];\r\n        res[value] = key;\r\n      });\r\n      return res;\r\n    });\r\n  }\r\n};\r\n\r\n//\r\n// Overrided methods\r\n//\r\n\r\noverrided.forEach(function(method) {\r\n  Node.prototype[method] = function _overrided() {\r\n    var state = this._baseState;\r\n    throw new Error(method + ' not implemented for encoding: ' + state.enc);\r\n  };\r\n});\r\n\r\n//\r\n// Public methods\r\n//\r\n\r\ntags.forEach(function(tag) {\r\n  Node.prototype[tag] = function _tagMethod() {\r\n    var state = this._baseState;\r\n    var args = Array.prototype.slice.call(arguments);\r\n\r\n    assert(state.tag === null);\r\n    state.tag = tag;\r\n\r\n    this._useArgs(args);\r\n\r\n    return this;\r\n  };\r\n});\r\n\r\nNode.prototype.use = function use(item) {\r\n  assert(item);\r\n  var state = this._baseState;\r\n\r\n  assert(state.use === null);\r\n  state.use = item;\r\n\r\n  return this;\r\n};\r\n\r\nNode.prototype.optional = function optional() {\r\n  var state = this._baseState;\r\n\r\n  state.optional = true;\r\n\r\n  return this;\r\n};\r\n\r\nNode.prototype.def = function def(val) {\r\n  var state = this._baseState;\r\n\r\n  assert(state['default'] === null);\r\n  state['default'] = val;\r\n  state.optional = true;\r\n\r\n  return this;\r\n};\r\n\r\nNode.prototype.explicit = function explicit(num) {\r\n  var state = this._baseState;\r\n\r\n  assert(state.explicit === null && state.implicit === null);\r\n  state.explicit = num;\r\n\r\n  return this;\r\n};\r\n\r\nNode.prototype.implicit = function implicit(num) {\r\n  var state = this._baseState;\r\n\r\n  assert(state.explicit === null && state.implicit === null);\r\n  state.implicit = num;\r\n\r\n  return this;\r\n};\r\n\r\nNode.prototype.obj = function obj() {\r\n  var state = this._baseState;\r\n  var args = Array.prototype.slice.call(arguments);\r\n\r\n  state.obj = true;\r\n\r\n  if (args.length !== 0)\r\n    this._useArgs(args);\r\n\r\n  return this;\r\n};\r\n\r\nNode.prototype.key = function key(newKey) {\r\n  var state = this._baseState;\r\n\r\n  assert(state.key === null);\r\n  state.key = newKey;\r\n\r\n  return this;\r\n};\r\n\r\nNode.prototype.any = function any() {\r\n  var state = this._baseState;\r\n\r\n  state.any = true;\r\n\r\n  return this;\r\n};\r\n\r\nNode.prototype.choice = function choice(obj) {\r\n  var state = this._baseState;\r\n\r\n  assert(state.choice === null);\r\n  state.choice = obj;\r\n  this._useArgs(Object.keys(obj).map(function(key) {\r\n    return obj[key];\r\n  }));\r\n\r\n  return this;\r\n};\r\n\r\nNode.prototype.contains = function contains(item) {\r\n  var state = this._baseState;\r\n\r\n  assert(state.use === null);\r\n  state.contains = item;\r\n\r\n  return this;\r\n};\r\n\r\n//\r\n// Decoding\r\n//\r\n\r\nNode.prototype._decode = function decode(input, options) {\r\n  var state = this._baseState;\r\n\r\n  // Decode root node\r\n  if (state.parent === null)\r\n    return input.wrapResult(state.children[0]._decode(input, options));\r\n\r\n  var result = state['default'];\r\n  var present = true;\r\n\r\n  var prevKey = null;\r\n  if (state.key !== null)\r\n    prevKey = input.enterKey(state.key);\r\n\r\n  // Check if tag is there\r\n  if (state.optional) {\r\n    var tag = null;\r\n    if (state.explicit !== null)\r\n      tag = state.explicit;\r\n    else if (state.implicit !== null)\r\n      tag = state.implicit;\r\n    else if (state.tag !== null)\r\n      tag = state.tag;\r\n\r\n    if (tag === null && !state.any) {\r\n      // Trial and Error\r\n      var save = input.save();\r\n      try {\r\n        if (state.choice === null)\r\n          this._decodeGeneric(state.tag, input, options);\r\n        else\r\n          this._decodeChoice(input, options);\r\n        present = true;\r\n      } catch (e) {\r\n        present = false;\r\n      }\r\n      input.restore(save);\r\n    } else {\r\n      present = this._peekTag(input, tag, state.any);\r\n\r\n      if (input.isError(present))\r\n        return present;\r\n    }\r\n  }\r\n\r\n  // Push object on stack\r\n  var prevObj;\r\n  if (state.obj && present)\r\n    prevObj = input.enterObject();\r\n\r\n  if (present) {\r\n    // Unwrap explicit values\r\n    if (state.explicit !== null) {\r\n      var explicit = this._decodeTag(input, state.explicit);\r\n      if (input.isError(explicit))\r\n        return explicit;\r\n      input = explicit;\r\n    }\r\n\r\n    var start = input.offset;\r\n\r\n    // Unwrap implicit and normal values\r\n    if (state.use === null && state.choice === null) {\r\n      if (state.any)\r\n        var save = input.save();\r\n      var body = this._decodeTag(\r\n        input,\r\n        state.implicit !== null ? state.implicit : state.tag,\r\n        state.any\r\n      );\r\n      if (input.isError(body))\r\n        return body;\r\n\r\n      if (state.any)\r\n        result = input.raw(save);\r\n      else\r\n        input = body;\r\n    }\r\n\r\n    if (options && options.track && state.tag !== null)\r\n      options.track(input.path(), start, input.length, 'tagged');\r\n\r\n    if (options && options.track && state.tag !== null)\r\n      options.track(input.path(), input.offset, input.length, 'content');\r\n\r\n    // Select proper method for tag\r\n    if (state.any)\r\n      result = result;\r\n    else if (state.choice === null)\r\n      result = this._decodeGeneric(state.tag, input, options);\r\n    else\r\n      result = this._decodeChoice(input, options);\r\n\r\n    if (input.isError(result))\r\n      return result;\r\n\r\n    // Decode children\r\n    if (!state.any && state.choice === null && state.children !== null) {\r\n      state.children.forEach(function decodeChildren(child) {\r\n        // NOTE: We are ignoring errors here, to let parser continue with other\r\n        // parts of encoded data\r\n        child._decode(input, options);\r\n      });\r\n    }\r\n\r\n    // Decode contained/encoded by schema, only in bit or octet strings\r\n    if (state.contains && (state.tag === 'octstr' || state.tag === 'bitstr')) {\r\n      var data = new DecoderBuffer(result);\r\n      result = this._getUse(state.contains, input._reporterState.obj)\r\n          ._decode(data, options);\r\n    }\r\n  }\r\n\r\n  // Pop object\r\n  if (state.obj && present)\r\n    result = input.leaveObject(prevObj);\r\n\r\n  // Set key\r\n  if (state.key !== null && (result !== null || present === true))\r\n    input.leaveKey(prevKey, state.key, result);\r\n  else if (prevKey !== null)\r\n    input.exitKey(prevKey);\r\n\r\n  return result;\r\n};\r\n\r\nNode.prototype._decodeGeneric = function decodeGeneric(tag, input, options) {\r\n  var state = this._baseState;\r\n\r\n  if (tag === 'seq' || tag === 'set')\r\n    return null;\r\n  if (tag === 'seqof' || tag === 'setof')\r\n    return this._decodeList(input, tag, state.args[0], options);\r\n  else if (/str$/.test(tag))\r\n    return this._decodeStr(input, tag, options);\r\n  else if (tag === 'objid' && state.args)\r\n    return this._decodeObjid(input, state.args[0], state.args[1], options);\r\n  else if (tag === 'objid')\r\n    return this._decodeObjid(input, null, null, options);\r\n  else if (tag === 'gentime' || tag === 'utctime')\r\n    return this._decodeTime(input, tag, options);\r\n  else if (tag === 'null_')\r\n    return this._decodeNull(input, options);\r\n  else if (tag === 'bool')\r\n    return this._decodeBool(input, options);\r\n  else if (tag === 'objDesc')\r\n    return this._decodeStr(input, tag, options);\r\n  else if (tag === 'int' || tag === 'enum')\r\n    return this._decodeInt(input, state.args && state.args[0], options);\r\n\r\n  if (state.use !== null) {\r\n    return this._getUse(state.use, input._reporterState.obj)\r\n        ._decode(input, options);\r\n  } else {\r\n    return input.error('unknown tag: ' + tag);\r\n  }\r\n};\r\n\r\nNode.prototype._getUse = function _getUse(entity, obj) {\r\n\r\n  var state = this._baseState;\r\n  // Create altered use decoder if implicit is set\r\n  state.useDecoder = this._use(entity, obj);\r\n  assert(state.useDecoder._baseState.parent === null);\r\n  state.useDecoder = state.useDecoder._baseState.children[0];\r\n  if (state.implicit !== state.useDecoder._baseState.implicit) {\r\n    state.useDecoder = state.useDecoder.clone();\r\n    state.useDecoder._baseState.implicit = state.implicit;\r\n  }\r\n  return state.useDecoder;\r\n};\r\n\r\nNode.prototype._decodeChoice = function decodeChoice(input, options) {\r\n  var state = this._baseState;\r\n  var result = null;\r\n  var match = false;\r\n\r\n  Object.keys(state.choice).some(function(key) {\r\n    var save = input.save();\r\n    var node = state.choice[key];\r\n    try {\r\n      var value = node._decode(input, options);\r\n      if (input.isError(value))\r\n        return false;\r\n\r\n      result = { type: key, value: value };\r\n      match = true;\r\n    } catch (e) {\r\n      input.restore(save);\r\n      return false;\r\n    }\r\n    return true;\r\n  }, this);\r\n\r\n  if (!match)\r\n    return input.error('Choice not matched');\r\n\r\n  return result;\r\n};\r\n\r\n//\r\n// Encoding\r\n//\r\n\r\nNode.prototype._createEncoderBuffer = function createEncoderBuffer(data) {\r\n  return new EncoderBuffer(data, this.reporter);\r\n};\r\n\r\nNode.prototype._encode = function encode(data, reporter, parent) {\r\n  var state = this._baseState;\r\n  if (state['default'] !== null && state['default'] === data)\r\n    return;\r\n\r\n  var result = this._encodeValue(data, reporter, parent);\r\n  if (result === undefined)\r\n    return;\r\n\r\n  if (this._skipDefault(result, reporter, parent))\r\n    return;\r\n\r\n  return result;\r\n};\r\n\r\nNode.prototype._encodeValue = function encode(data, reporter, parent) {\r\n  var state = this._baseState;\r\n\r\n  // Decode root node\r\n  if (state.parent === null)\r\n    return state.children[0]._encode(data, reporter || new Reporter());\r\n\r\n  var result = null;\r\n\r\n  // Set reporter to share it with a child class\r\n  this.reporter = reporter;\r\n\r\n  // Check if data is there\r\n  if (state.optional && data === undefined) {\r\n    if (state['default'] !== null)\r\n      data = state['default']\r\n    else\r\n      return;\r\n  }\r\n\r\n  // Encode children first\r\n  var content = null;\r\n  var primitive = false;\r\n  if (state.any) {\r\n    // Anything that was given is translated to buffer\r\n    result = this._createEncoderBuffer(data);\r\n  } else if (state.choice) {\r\n    result = this._encodeChoice(data, reporter);\r\n  } else if (state.contains) {\r\n    content = this._getUse(state.contains, parent)._encode(data, reporter);\r\n    primitive = true;\r\n  } else if (state.children) {\r\n    content = state.children.map(function(child) {\r\n      if (child._baseState.tag === 'null_')\r\n        return child._encode(null, reporter, data);\r\n\r\n      if (child._baseState.key === null)\r\n        return reporter.error('Child should have a key');\r\n      var prevKey = reporter.enterKey(child._baseState.key);\r\n\r\n      if (typeof data !== 'object')\r\n        return reporter.error('Child expected, but input is not object');\r\n\r\n      var res = child._encode(data[child._baseState.key], reporter, data);\r\n      reporter.leaveKey(prevKey);\r\n\r\n      return res;\r\n    }, this).filter(function(child) {\r\n      return child;\r\n    });\r\n    content = this._createEncoderBuffer(content);\r\n  } else {\r\n    if (state.tag === 'seqof' || state.tag === 'setof') {\r\n      // TODO(indutny): this should be thrown on DSL level\r\n      if (!(state.args && state.args.length === 1))\r\n        return reporter.error('Too many args for : ' + state.tag);\r\n\r\n      if (!Array.isArray(data))\r\n        return reporter.error('seqof/setof, but data is not Array');\r\n\r\n      var child = this.clone();\r\n      child._baseState.implicit = null;\r\n      content = this._createEncoderBuffer(data.map(function(item) {\r\n        var state = this._baseState;\r\n\r\n        return this._getUse(state.args[0], data)._encode(item, reporter);\r\n      }, child));\r\n    } else if (state.use !== null) {\r\n      result = this._getUse(state.use, parent)._encode(data, reporter);\r\n    } else {\r\n      content = this._encodePrimitive(state.tag, data);\r\n      primitive = true;\r\n    }\r\n  }\r\n\r\n  // Encode data itself\r\n  var result;\r\n  if (!state.any && state.choice === null) {\r\n    var tag = state.implicit !== null ? state.implicit : state.tag;\r\n    var cls = state.implicit === null ? 'universal' : 'context';\r\n\r\n    if (tag === null) {\r\n      if (state.use === null)\r\n        reporter.error('Tag could be omitted only for .use()');\r\n    } else {\r\n      if (state.use === null)\r\n        result = this._encodeComposite(tag, primitive, cls, content);\r\n    }\r\n  }\r\n\r\n  // Wrap in explicit\r\n  if (state.explicit !== null)\r\n    result = this._encodeComposite(state.explicit, false, 'context', result);\r\n\r\n  return result;\r\n};\r\n\r\nNode.prototype._encodeChoice = function encodeChoice(data, reporter) {\r\n  var state = this._baseState;\r\n\r\n  var node = state.choice[data.type];\r\n  if (!node) {\r\n    assert(\r\n        false,\r\n        data.type + ' not found in ' +\r\n            JSON.stringify(Object.keys(state.choice)));\r\n  }\r\n  return node._encode(data.value, reporter);\r\n};\r\n\r\nNode.prototype._encodePrimitive = function encodePrimitive(tag, data) {\r\n  var state = this._baseState;\r\n\r\n  if (/str$/.test(tag))\r\n    return this._encodeStr(data, tag);\r\n  else if (tag === 'objid' && state.args)\r\n    return this._encodeObjid(data, state.reverseArgs[0], state.args[1]);\r\n  else if (tag === 'objid')\r\n    return this._encodeObjid(data, null, null);\r\n  else if (tag === 'gentime' || tag === 'utctime')\r\n    return this._encodeTime(data, tag);\r\n  else if (tag === 'null_')\r\n    return this._encodeNull();\r\n  else if (tag === 'int' || tag === 'enum')\r\n    return this._encodeInt(data, state.args && state.reverseArgs[0]);\r\n  else if (tag === 'bool')\r\n    return this._encodeBool(data);\r\n  else if (tag === 'objDesc')\r\n    return this._encodeStr(data, tag);\r\n  else\r\n    throw new Error('Unsupported tag: ' + tag);\r\n};\r\n\r\nNode.prototype._isNumstr = function isNumstr(str) {\r\n  return /^[0-9 ]*$/.test(str);\r\n};\r\n\r\nNode.prototype._isPrintstr = function isPrintstr(str) {\r\n  return /^[A-Za-z0-9 '\\(\\)\\+,\\-\\.\\/:=\\?]*$/.test(str);\r\n};\r\n"]},"metadata":{},"sourceType":"script"}